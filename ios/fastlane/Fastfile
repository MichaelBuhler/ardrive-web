import "../../Fastfile"

# Update fastlane
update_fastlane

default_platform(:ios)

platform :ios do
  lane :build_adhoc do
    # Flutter build
    fetch_dependencies
    build_autogenerated_code

    # Pod install
    sh("bundle", "exec", "pod", "install")

    # Set CI build number if CI
    if is_ci
      increment_build_number(
        build_number: ENV['BUILD_NUMBER']
      )
    end

    # Build iOS project and generate an ad-hoc signed ipa
    build_ios_app(
      workspace: "Runner.xcworkspace",
      scheme: "Runner",
      include_bitcode: true,
      export_method: "ad-hoc",
      clean: true,
    )
  end

  lane :deploy_feature_branch do
    # Setup keychain if CI
    setup_ci if is_ci

    # Download and install adhoc certificate and profile
    match(
      type: "adhoc",
      app_identifier: "io.ardrive.app"
    )

    build_adhoc

    # Distribute to Firebase
    firebase_app_distribution(
      app: "1:305132849030:ios:06ea33a95a2e0d42ffce07",
      release_notes: ENV['RELEASE_NOTES'],
      service_credentials_file: ENV['FIREBASE_JSON'],
      groups: "Testers"
    )
  end
end
